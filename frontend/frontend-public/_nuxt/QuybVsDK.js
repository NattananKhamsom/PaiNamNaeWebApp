import{_ as ue,m as me,r as b,x as se,y as ge,i as pe,p as fe,c as n,a as t,b as ve,F as T,q as N,g as _,t as r,s as he,o as l,n as oe,d as ye,f as P}from"./DPSIKoxe.js";import{d as F}from"./B5yDJBm8.js";import{b as be}from"./C5FTVxxA.js";import{C as _e}from"./CL2Ezi0q.js";import{s as xe}from"./x_rD_Ya3.js";import{u as we}from"./BaxiziUg.js";import"./Cpj98o6Y.js";const ke={class:"px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8"},Ce={class:"p-6 mb-8 bg-white border border-gray-300 rounded-lg shadow-md"},Me={class:"flex flex-wrap gap-2"},Te=["onClick"],$e={class:"grid grid-cols-1 gap-6 lg:grid-cols-3"},Ne={class:"lg:col-span-2"},Pe={class:"bg-white border border-gray-300 rounded-lg shadow-md"},je={key:0,class:"p-12 text-center text-gray-500"},Be={key:1,class:"divide-y divide-gray-200"},Ae={key:0,class:"p-12 text-center text-gray-500"},Le=["onClick"],Ve={class:"flex items-start justify-between mb-4"},De={class:"flex-1"},He={class:"flex items-center justify-between"},Fe={class:"text-lg font-semibold text-gray-900"},Se={key:0,class:"status-badge status-pending"},Ee={key:1,class:"status-badge status-confirmed"},Oe={key:2,class:"status-badge status-rejected"},ze={key:3,class:"status-badge status-cancelled"},Ie={class:"mt-1 text-sm text-gray-600"},Ge={class:"text-sm text-gray-600"},Ke={class:"flex items-center mb-4 space-x-4"},Re=["src","alt"],qe={class:"flex-1"},Je={class:"flex items-center"},Ue={class:"font-medium text-gray-900"},We={key:0,class:"relative group ml-1.5 flex items-center"},Qe={class:"flex"},Xe={key:0,class:"text-xs text-gray-500 mt-0.5"},Ye=["href"],Ze=["onClick"],et={class:"flex items-center mt-1"},tt={class:"flex text-sm text-yellow-400"},st={class:"ml-2 text-sm text-gray-600"},ot={class:"text-right"},at={class:"text-lg font-bold text-blue-600"},nt={class:"text-sm text-gray-600"},lt={key:0,class:"pt-4 mt-4 mb-5 duration-300 border-t border-gray-300 animate-in slide-in-from-top"},it={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},rt={class:"space-y-1 text-sm text-gray-600"},dt={class:"space-y-1 text-sm text-gray-600"},ct={class:"mt-4 space-y-4"},ut={key:0},mt={class:"p-3 text-sm text-gray-700 border border-gray-300 rounded-md bg-gray-50"},gt={key:1},pt={class:"grid grid-cols-3 gap-2 mt-2"},ft=["src"],vt=["onClick"],ht=["onClick"],yt={key:1,class:"px-4 py-2 text-sm text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700"},bt=["onClick"],_t={class:"lg:col-span-1"},xt={class:"sticky overflow-hidden bg-white border border-gray-300 rounded-lg shadow-md top-8"},wt={class:"p-3 border-gray-300"},kt={class:"mt-1 text-sm text-gray-600"},W="__gmapsReady__",Ct={__name:"index_v2",setup(Mt){var ee;F.locale("th"),F.extend(be);const{$api:S}=me(),{toast:k}=he(),$=b("pending"),C=b(null),E=b(!1),O=b(null),u=b([]);let v=null,j=null,B=null,A=null,z=null,I=null;const G=b(!1),ae=[{status:"pending",label:"รอดำเนินการ"},{status:"confirmed",label:"ยืนยันแล้ว"},{status:"rejected",label:"ปฏิเสธ"},{status:"cancelled",label:"ยกเลิก"},{status:"all",label:"ทั้งหมด"}],x=se(()=>$.value==="all"?u.value:u.value.filter(o=>o.status===$.value)),K=se(()=>u.value.find(o=>o.id===C.value)||null);async function R(){var o,s,e,a,d,m,g,h,D;E.value=!0;try{const M=await S("/routes/me"),te=[];for(const i of M){const y=[];i.vehicle?(y.push(`${i.vehicle.vehicleModel} (${i.vehicle.vehicleType})`),Array.isArray(i.vehicle.amenities)&&i.vehicle.amenities.length>0&&y.push(...i.vehicle.amenities)):y.push("ไม่มีข้อมูลรถ");const p=i.startLocation,f=i.endLocation,H=[[p.lat,p.lng],[f.lat,f.lng]];for(const c of i.bookings||[])te.push({id:c.id,status:(c.status||"").toLowerCase(),origin:(p==null?void 0:p.name)||`(${Number(p.lat).toFixed(2)}, ${Number(p.lng).toFixed(2)})`,destination:(f==null?void 0:f.name)||`(${Number(f.lat).toFixed(2)}, ${Number(f.lng).toFixed(2)})`,originHasName:!!(p!=null&&p.name),destinationHasName:!!(f!=null&&f.name),pickupPoint:((o=c.pickupLocation)==null?void 0:o.name)||"-",date:F(i.departureTime).format("D MMMM BBBB"),time:F(i.departureTime).format("HH:mm น."),price:(i.pricePerSeat||0)*(c.numberOfSeats||0),seats:c.numberOfSeats||0,passenger:{name:`${((s=c.passenger)==null?void 0:s.firstName)||""} ${((e=c.passenger)==null?void 0:e.lastName)||""}`.trim()||"ผู้โดยสาร",image:((a=c.passenger)==null?void 0:a.profilePicture)||`https://ui-avatars.com/api/?name=${encodeURIComponent(((d=c.passenger)==null?void 0:d.firstName)||"P")}&background=random&size=64`,email:((m=c.passenger)==null?void 0:m.email)||"",isVerified:!!((g=c.passenger)!=null&&g.isVerified),rating:4.5,reviews:Math.floor(Math.random()*50)+5},coords:H,polyline:i.routePolyline||null,stops:["ไม่มีข้อมูลจุดแวะพัก"],carDetails:y,conditions:i.conditions,photos:((h=i.vehicle)==null?void 0:h.photos)||[]})}u.value=te,await Q();const ce=u.value.map(async(i,y)=>{const[p,f]=await Promise.all([X(i.coords[0][0],i.coords[0][1]),X(i.coords[1][0],i.coords[1][1])]),H=await Y(p),c=await Y(f);!u.value[y].originHasName&&H.name&&(u.value[y].origin=H.name),!u.value[y].destinationHasName&&c.name&&(u.value[y].destination=c.name)});await Promise.allSettled(ce)}catch(M){console.error("Failed to fetch routes:",M),u.value=[],k.error("เกิดข้อผิดพลาด",((D=M==null?void 0:M.data)==null?void 0:D.message)||"ไม่สามารถโหลดข้อมูลได้")}finally{E.value=!1}}const ne=o=>o==="all"?u.value.length:u.value.filter(s=>s.status===o).length,le=o=>{const s=u.value.find(e=>e.id===o);s&&L(s),C.value=C.value===o?null:o};function Q(){return new Promise(o=>{if(G.value)return o(!0);const s=xe(()=>{G.value&&(clearInterval(s),o(!0))},50)})}function X(o,s){return new Promise(e=>{if(!z)return e(null);z.geocode({location:{lat:o,lng:s}},(a,d)=>{if(d!=="OK"||!(a!=null&&a.length))return e(null);e(a[0])})})}async function Y(o){if(!o)return{name:null,area:null};const s=o.address_components||[],e=g=>{var h;return(h=s.find(D=>D.types.includes(g)))==null?void 0:h.long_name},a=o.types||[],d=a.includes("point_of_interest")||a.includes("establishment")||a.includes("premise");let m=null;if(d&&o.place_id){const g=await ie(o.place_id);g&&(m=g)}if(!m){const g=e("street_number"),h=e("route");m=g&&h?`${g} ${h}`:h||o.formatted_address||null}return m&&(m=m.replace(/,?\s*(Thailand|ไทย)\s*$/i,"")),{name:m}}function ie(o){return new Promise(s=>{if(!I||!o)return s(null);I.getDetails({placeId:o,fields:["name"]},(e,a)=>{a===google.maps.places.PlacesServiceStatus.OK&&(e!=null&&e.name)?s(e.name):s(null)})})}async function L(o){var a;if(!o||(await Q(),!v))return;j&&(j.setMap(null),j=null),B&&(B.setMap(null),B=null),A&&(A.setMap(null),A=null);const s={lat:Number(o.coords[0][0]),lng:Number(o.coords[0][1])},e={lat:Number(o.coords[1][0]),lng:Number(o.coords[1][1])};if(B=new google.maps.Marker({position:s,map:v,label:"A"}),A=new google.maps.Marker({position:e,map:v,label:"B"}),o.polyline&&((a=google.maps.geometry)!=null&&a.encoding)){const d=google.maps.geometry.encoding.decodePath(o.polyline);j=new google.maps.Polyline({path:d,map:v,strokeColor:"#2563eb",strokeOpacity:.9,strokeWeight:5});const m=new google.maps.LatLngBounds;d.forEach(g=>m.extend(g)),v.fitBounds(m)}else{const d=new google.maps.LatLngBounds;d.extend(s),d.extend(e),v.fitBounds(d)}}const q=b(!1),V=b(null),w=b({title:"",message:"",confirmText:"",action:null,variant:"danger"}),J=(o,s)=>{V.value=o,s==="confirm"?w.value={title:"ยืนยันคำขอจอง",message:`ยืนยันคำขอของผู้โดยสาร "${o.passenger.name}" ใช่หรือไม่?`,confirmText:"ยืนยันคำขอ",action:"confirm",variant:"primary"}:s==="reject"?w.value={title:"ปฏิเสธคำขอจอง",message:`ต้องการปฏิเสธคำขอของ "${o.passenger.name}" ใช่หรือไม่?`,confirmText:"ปฏิเสธ",action:"reject",variant:"danger"}:s==="delete"&&(w.value={title:"ยืนยันการลบรายการ",message:"ต้องการลบคำขอนี้ออกจากรายการใช่หรือไม่?",confirmText:"ลบรายการ",action:"delete",variant:"danger"}),q.value=!0},U=()=>{q.value=!1,V.value=null},re=async()=>{var e;if(!V.value)return;const o=w.value.action,s=V.value.id;try{o==="confirm"?(await S(`/bookings/${s}/status`,{method:"PATCH",body:{status:"CONFIRMED"}}),k.success("สำเร็จ","ยืนยันคำขอแล้ว")):o==="reject"?(await S(`/bookings/${s}/status`,{method:"PATCH",body:{status:"REJECTED"}}),k.success("สำเร็จ","ปฏิเสธคำขอแล้ว")):o==="delete"&&console.log(`Delete booking ${s} (TODO)`),U(),await R()}catch(a){console.error(`Failed to ${o} booking:`,a),k.error("เกิดข้อผิดพลาด",((e=a==null?void 0:a.data)==null?void 0:e.message)||"ไม่สามารถดำเนินการได้"),U()}},de=async o=>{try{await navigator.clipboard.writeText(o),k.success("คัดลอกแล้ว",o)}catch{k.error("คัดลอกไม่สำเร็จ","ลองใหม่อีกครั้ง")}};we({script:(ee=window.google)!=null&&ee.maps?[]:[{key:"gmaps",src:`https://maps.googleapis.com/maps/api/js?key=${ge().public.googleMapsApiKey}&libraries=places,geometry&callback=${W}`,async:!0,defer:!0}]}),pe(()=>{var o;if((o=window.google)!=null&&o.maps){Z(),R().then(()=>{x.value.length&&L(x.value[0])});return}window[W]=()=>{try{delete window[W]}catch{}Z(),R().then(()=>{x.value.length&&L(x.value[0])})}});function Z(){!O.value||v||(v=new google.maps.Map(O.value,{center:{lat:13.7563,lng:100.5018},zoom:6,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!0}),z=new google.maps.Geocoder,I=new google.maps.places.PlacesService(v),G.value=!0)}return fe($,()=>{C.value=null,x.value.length>0&&L(x.value[0])}),(o,s)=>(l(),n("div",null,[t("div",ke,[s[12]||(s[12]=t("div",{class:"mb-8"},[t("h2",{class:"text-2xl font-bold text-gray-900"},"คำขอจองเส้นทางของฉัน"),t("p",{class:"mt-2 text-gray-600"},"ดูและจัดการคำขอจองจากผู้โดยสารในเส้นทางที่คุณสร้าง")],-1)),t("div",Ce,[t("div",Me,[(l(),n(T,null,N(ae,e=>t("button",{key:e.status,onClick:a=>$.value=e.status,class:oe(["tab-button px-4 py-2 rounded-md font-medium",{active:$.value===e.status}])},r(e.label)+" ("+r(ne(e.status))+") ",11,Te)),64))])]),t("div",$e,[t("div",Ne,[t("div",Pe,[s[10]||(s[10]=t("div",{class:"p-6 border-b border-gray-300"},[t("h3",{class:"text-lg font-semibold text-gray-900"},"รายการคำขอจอง")],-1)),E.value?(l(),n("div",je,s[1]||(s[1]=[t("p",null,"กำลังโหลดข้อมูล...",-1)]))):(l(),n("div",Be,[x.value.length===0?(l(),n("div",Ae,s[2]||(s[2]=[t("p",null,"ไม่พบรายการในหมวดหมู่นี้",-1)]))):_("",!0),(l(!0),n(T,null,N(x.value,e=>(l(),n("div",{key:e.id,class:"p-6 transition-colors duration-200 cursor-pointer trip-card hover:bg-gray-50",onClick:a=>le(e.id)},[t("div",Ve,[t("div",De,[t("div",He,[t("h4",Fe,r(e.origin)+" → "+r(e.destination),1),e.status==="pending"?(l(),n("span",Se,"รอดำเนินการ")):e.status==="confirmed"?(l(),n("span",Ee,"ยืนยันแล้ว")):e.status==="rejected"?(l(),n("span",Oe,"ปฏิเสธ")):e.status==="cancelled"?(l(),n("span",ze,"ยกเลิก")):_("",!0)]),t("p",Ie,"จุดนัดพบ: "+r(e.pickupPoint),1),t("p",Ge,"วันที่: "+r(e.date)+" เวลา: "+r(e.time),1)])]),t("div",Ke,[t("img",{src:e.passenger.image,alt:e.passenger.name,class:"object-cover rounded-full w-15 h-15"},null,8,Re),t("div",qe,[t("div",Je,[t("h5",Ue,r(e.passenger.name),1),e.passenger.isVerified?(l(),n("div",We,s[3]||(s[3]=[t("svg",{class:"w-5 h-5 text-blue-600",viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.498 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.07-.01l3.5-4.875z","clip-rule":"evenodd"})],-1),t("span",{class:"absolute px-2 py-1 mb-2 text-xs text-white transition-opacity -translate-x-1/2 bg-gray-800 rounded-md opacity-0 pointer-events-none bottom-full left-1/2 w-max group-hover:opacity-100"}," ผู้โดยสารยืนยันตัวตนแล้ว ",-1)]))):_("",!0)]),t("div",Qe,[e.passenger.email?(l(),n("p",Xe,[s[4]||(s[4]=ye(" อีเมล: ")),t("a",{href:`mailto:${e.passenger.email}`,class:"text-blue-600 hover:underline",onClick:s[0]||(s[0]=P(()=>{},["stop"]))},r(e.passenger.email),9,Ye)])):_("",!0),e.passenger.email?(l(),n("button",{key:1,class:"inline-flex items-center ml-1 text-gray-500 rounded hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",title:"คัดลอกอีเมล","aria-label":"คัดลอกอีเมล",onClick:P(a=>de(e.passenger.email),["stop"])},s[5]||(s[5]=[t("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z"}),t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7V5a2 2 0 00-2-2H8a2 2 0 00-2 2v2"})],-1)]),8,Ze)):_("",!0)]),t("div",et,[t("div",tt,[t("span",null,r("★".repeat(Math.round(e.passenger.rating)))+r("☆".repeat(5-Math.round(e.passenger.rating))),1)]),t("span",st,r(e.passenger.rating)+" ("+r(e.passenger.reviews)+" รีวิว) ",1)])]),t("div",ot,[t("div",at,r(e.price)+" บาท",1),t("div",nt,"จำนวน "+r(e.seats)+" ที่นั่ง",1)])]),C.value===e.id?(l(),n("div",lt,[t("div",it,[t("div",null,[s[6]||(s[6]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดเส้นทาง",-1)),t("ul",rt,[(l(!0),n(T,null,N(e.stops,a=>(l(),n("li",{key:a},"• "+r(a),1))),128))])]),t("div",null,[s[7]||(s[7]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดรถ",-1)),t("ul",dt,[(l(!0),n(T,null,N(e.carDetails,a=>(l(),n("li",{key:a},"• "+r(a),1))),128))])])]),t("div",ct,[e.conditions?(l(),n("div",ut,[s[8]||(s[8]=t("h5",{class:"mb-2 font-medium text-gray-900"},"เงื่อนไขการเดินทาง",-1)),t("p",mt,r(e.conditions),1)])):_("",!0),e.photos&&e.photos.length>0?(l(),n("div",gt,[s[9]||(s[9]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รูปภาพรถยนต์",-1)),t("div",pt,[(l(!0),n(T,null,N(e.photos.slice(0,3),(a,d)=>(l(),n("div",{key:d},[t("img",{src:a,alt:"Vehicle photo",class:"object-cover w-full transition-opacity rounded-lg shadow-sm cursor-pointer aspect-video hover:opacity-90"},null,8,ft)]))),128))])])):_("",!0)])])):_("",!0),t("div",{class:oe(["flex justify-end space-x-3",{"mt-4":C.value!==e.id}])},[e.status==="pending"?(l(),n(T,{key:0},[t("button",{onClick:P(a=>J(e,"confirm"),["stop"]),class:"px-4 py-2 text-sm text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700"}," ยืนยันคำขอ ",8,vt),t("button",{onClick:P(a=>J(e,"reject"),["stop"]),class:"px-4 py-2 text-sm text-red-600 transition duration-200 border border-red-300 rounded-md hover:bg-red-50"}," ปฏิเสธ ",8,ht)],64)):e.status==="confirmed"?(l(),n("button",yt," แชทกับผู้โดยสาร ")):["rejected","cancelled"].includes(e.status)?(l(),n("button",{key:2,onClick:P(a=>J(e,"delete"),["stop"]),class:"px-4 py-2 text-sm text-gray-600 transition duration-200 border border-gray-300 rounded-md hover:bg-gray-50"}," ลบรายการ ",8,bt)):_("",!0)],2)],8,Le))),128))]))])]),t("div",_t,[t("div",xt,[t("div",wt,[s[11]||(s[11]=t("h3",{class:"text-lg font-semibold text-gray-900"},"แผนที่เส้นทาง",-1)),t("p",kt,r(K.value?K.value.origin+" → "+K.value.destination:"คลิกที่รายการเพื่อดูเส้นทาง"),1)]),t("div",{ref_key:"mapContainer",ref:O,id:"map"},null,512)])])])]),ve(_e,{show:q.value,title:w.value.title,message:w.value.message,confirmText:w.value.confirmText,variant:w.value.variant,onConfirm:re,onCancel:U},null,8,["show","title","message","confirmText","variant"])]))}},Lt=ue(Ct,[["__scopeId","data-v-e442a222"]]);export{Lt as default};
