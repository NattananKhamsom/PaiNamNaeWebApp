import{r as b,A as F,x as H,i as ne,H as ie,c as u,b as U,a as t,h as g,v as k,I as le,z as V,e as re,t as c,g as $,F as M,q,y as N,J as T,s as de,C as S,o as p,n as A,d as P}from"./DPSIKoxe.js";import{u as ce}from"./BaxiziUg.js";import{d as z}from"./B5yDJBm8.js";import{b as ue}from"./C5FTVxxA.js";import{A as pe,_ as me}from"./CaCOxDSn.js";import{C as ge}from"./CL2Ezi0q.js";import"./Cpj98o6Y.js";import"./Lcixqshc.js";import"./DOK8vhV6.js";const fe={class:""},xe={id:"main-content",class:"main-content mt-16 ml-0 lg:ml-[280px] p-6"},ye={class:"mx-auto max-w-8xl"},be={class:"flex flex-col gap-3 mb-6 sm:flex-row sm:items-center sm:justify-between"},ve={class:"flex items-center gap-2"},he={class:"mb-4 bg-white border border-gray-300 rounded-lg shadow-sm"},we={class:"grid grid-cols-1 gap-3 px-4 py-4 sm:px-6 lg:grid-cols-[repeat(24,minmax(0,1fr))]"},_e={class:"lg:col-span-3"},ke={class:"lg:col-span-3"},Ae={class:"lg:col-span-3"},Le={class:"lg:col-span-4"},Be={class:"lg:col-span-4"},Ce={class:"lg:col-span-3"},Ee={class:"bg-white border border-gray-300 rounded-lg shadow-sm"},Ie={class:"flex items-center justify-between px-4 py-4 border-b border-gray-200 sm:px-6"},Ue={class:"text-sm text-gray-600"},Ve={key:0,class:"p-8 text-center text-gray-500"},$e={key:1,class:"p-8 text-center text-red-600"},Me={key:2,class:"overflow-x-auto"},Ne={class:"min-w-full divide-y divide-gray-200"},Te={class:"bg-white divide-y divide-gray-200"},Se={class:"px-4 py-3"},ze={class:"flex items-center gap-3"},De=["src"],Re={class:"font-medium text-gray-900"},je={class:"text-xs text-gray-500"},Fe={class:"px-4 py-3 text-gray-700"},He={class:"px-4 py-3 text-gray-700"},qe={class:"px-4 py-3"},Pe={key:0,class:"mr-1 fa-solid fa-shield-halved"},Oe={class:"px-4 py-3"},Ye={key:0,class:"mr-1 fa-solid fa-circle-check"},Ge={class:"px-4 py-3"},Je={class:"flex items-center"},Ke={class:"inline-flex items-center cursor-pointer select-none switch"},We=["checked","disabled","onChange"],Qe={class:"px-4 py-3 text-gray-700"},Xe={class:"text-sm"},Ze={class:"text-xs text-gray-500"},et={class:"px-4 py-3"},tt=["onClick"],st=["onClick"],ot=["onClick"],at={key:0},nt={class:"flex flex-col gap-3 px-4 py-4 border-t border-gray-200 sm:px-6 sm:flex-row sm:items-center sm:justify-between"},it={class:"flex flex-wrap items-center gap-3 text-sm"},lt={class:"flex items-center gap-2"},rt={class:"flex items-center gap-1"},dt=["disabled"],ct={key:0,class:"px-2 text-sm text-gray-500"},ut=["disabled","onClick"],pt=["disabled"],kt={__name:"index",setup(mt){z.locale("th"),z.extend(ue);const{toast:v}=de(),f=b(!1),h=b(""),L=b([]),C=b(new Set),l=F({page:1,limit:20,total:0,totalPages:1}),i=F({q:"",role:"",createdFrom:"",createdTo:"",sort:"",isVerified:"",isActive:""}),w=H(()=>Math.max(1,l.totalPages||Math.ceil((l.total||0)/(l.limit||20)))),O=H(()=>{const o=w.value,e=l.page;if(!o||o<1)return[];if(o<=5)return Array.from({length:o},(n,d)=>d+1);const a=new Set([1,o,e]);e-1>1&&a.add(e-1),e+1<o&&a.add(e+1);const s=Array.from(a).sort((n,d)=>n-d),r=[];for(let n=0;n<s.length;n++)n>0&&s[n]-s[n-1]>1&&r.push("…"),r.push(s[n]);return r});function Y(o){return o==="ADMIN"?"bg-purple-100 text-purple-700":o==="DRIVER"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}function D(o){return o?z(o).format("D MMMM BBBB HH:mm"):"-"}function G(o){const[e,a]=(o||"").split(":");return!e||!["asc","desc"].includes(a)?{sortBy:void 0,sortOrder:void 0}:{sortBy:e,sortOrder:a}}function R(o){if(!(o===""||o===void 0||o===null)){if(o===!0||o==="true")return!0;if(o===!1||o==="false")return!1}}async function _(o=1){var e;f.value=!0,h.value="";try{const a=N(),s=T("token").value||localStorage.getItem("token"),{sortBy:r,sortOrder:n}=G(i.sort),d=await $fetch("/users/admin",{baseURL:a.public.apiBase,headers:{Accept:"application/json",...s?{Authorization:`Bearer ${s}`}:{}},query:{page:o,limit:l.limit,q:i.q||void 0,role:i.role||void 0,createdFrom:i.createdFrom||void 0,createdTo:i.createdTo||void 0,sortBy:r,sortOrder:n,isVerified:R(i.isVerified),isActive:R(i.isActive)}}),m=(d==null?void 0:d.data)||(d==null?void 0:d.items)||[],x=(d==null?void 0:d.pagination)||{};L.value=m,l.page=Number(x.page??o),l.limit=Number(x.limit??l.limit),l.total=Number(x.total??m.length),l.totalPages=Number(x.totalPages??Math.ceil(l.total/l.limit))}catch(a){console.error(a),h.value=((e=a==null?void 0:a.data)==null?void 0:e.message)||"ไม่สามารถโหลดข้อมูลได้",v.error("เกิดข้อผิดพลาด",h.value),L.value=[]}finally{f.value=!1}}function E(o){o<1||o>w.value||_(o)}function B(){l.page=1,_(1)}function J(){i.q="",i.role="",i.createdFrom="",i.createdTo="",i.sort="",i.isVerified="",i.isActive="",l.page=1,_(1)}function K(o){S(`/admin/users/${o.id}/edit`).catch(()=>{})}async function W(o,e){const a=o.isActive;if(a===e)return;o.isActive=e,C.value.add(o.id);const s=N(),r=T("token").value||localStorage.getItem("token");try{const n=await fetch(`${s.public.apiBase}/users/admin/${o.id}/status`,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}},body:JSON.stringify({isActive:e}),credentials:"include"});let d;try{d=await n.json()}catch{const m=await n.text(),x=new Error(m||"Unexpected response from server");throw x.status=n.status,x}if(!n.ok){const m=new Error((d==null?void 0:d.message)||`Request failed with status ${n.status}`);throw m.status=n.status,m.payload=d,m}v.success("อัปเดตสถานะแล้ว",e?"เปิดใช้งานบัญชีสำเร็จ":"ปิดการใช้งานบัญชีสำเร็จ")}catch(n){o.isActive=a,console.error(n),v.error("อัปเดตสถานะไม่สำเร็จ",(n==null?void 0:n.message)||"เกิดข้อผิดพลาด")}finally{C.value.delete(o.id)}}const I=b(!1),y=b(null);function Q(o){y.value=o,I.value=!0}function j(){I.value=!1,y.value=null}async function X(){var e;if(!y.value)return;const o=y.value;try{await Z(o.id),v.success("ลบผู้ใช้เรียบร้อย",`${o.email||o.username||o.id} ถูกลบถาวรแล้ว`),j(),_(Math.min(l.page,w.value))}catch(a){console.error(a);const s=(a==null?void 0:a.message)||((e=a==null?void 0:a.data)==null?void 0:e.message)||"ลบไม่สำเร็จ";v.error("ลบไม่สำเร็จ",s)}}async function Z(o){const e=N(),a=T("token").value||localStorage.getItem("token"),s=await fetch(`${e.public.apiBase}/users/admin/${o}`,{method:"DELETE",headers:{Accept:"application/json",...a?{Authorization:`Bearer ${a}`}:{}},credentials:"include"});let r;try{r=await s.json()}catch{const n=await s.text(),d=new Error(n||"Unexpected response from server");throw d.status=s.status,d}if(!s.ok){const n=new Error((r==null?void 0:r.message)||`Request failed with status ${s.status}`);throw n.status=s.status,n.payload=r,n}return r}ce({});function ee(){S("/admin/users/create").catch(()=>{})}function te(o){S(`/admin/users/${o.id}`).catch(()=>{})}function se(){const o=document.getElementById("sidebar"),e=document.getElementById("overlay");!o||!e||(o.classList.remove("mobile-open"),e.classList.add("hidden"))}function oe(){window.toggleSidebar=function(){const o=document.getElementById("sidebar"),e=document.getElementById("main-content"),a=document.getElementById("toggle-icon");!o||!e||!a||(o.classList.toggle("collapsed"),o.classList.contains("collapsed")?(e.style.marginLeft="80px",a.classList.replace("fa-chevron-left","fa-chevron-right")):(e.style.marginLeft="280px",a.classList.replace("fa-chevron-right","fa-chevron-left")))},window.toggleMobileSidebar=function(){const o=document.getElementById("sidebar"),e=document.getElementById("overlay");!o||!e||(o.classList.toggle("mobile-open"),e.classList.toggle("hidden"))},window.toggleSubmenu=function(o){const e=document.getElementById(o),a=document.getElementById(o+"-icon");!e||!a||(e.classList.toggle("hidden"),e.classList.contains("hidden")?a.classList.replace("fa-chevron-up","fa-chevron-down"):a.classList.replace("fa-chevron-down","fa-chevron-up"))},window.__adminResizeHandler__=function(){const o=document.getElementById("sidebar"),e=document.getElementById("main-content"),a=document.getElementById("overlay");!o||!e||!a||(window.innerWidth>=1024?(o.classList.remove("mobile-open"),a.classList.add("hidden"),o.classList.contains("collapsed")?e.style.marginLeft="80px":e.style.marginLeft="280px"):e.style.marginLeft="0")},window.addEventListener("resize",window.__adminResizeHandler__)}function ae(){window.removeEventListener("resize",window.__adminResizeHandler__||(()=>{})),delete window.toggleSidebar,delete window.toggleMobileSidebar,delete window.closeMobileSidebar,delete window.toggleSubmenu,delete window.__adminResizeHandler__}return ne(()=>{oe(),typeof window.__adminResizeHandler__=="function"&&window.__adminResizeHandler__(),_(1)}),ie(()=>{ae()}),(o,e)=>{var a;return p(),u("div",fe,[U(pe),U(me),t("main",xe,[t("div",ye,[t("div",be,[t("div",{class:"flex items-center gap-3"},[e[11]||(e[11]=t("h1",{class:"text-2xl font-semibold text-gray-800"},"User Management",-1)),t("button",{onClick:ee,class:"inline-flex items-center gap-2 px-3 py-2 text-white bg-blue-600 rounded-md cursor-pointer hover:bg-blue-700"},e[10]||(e[10]=[t("i",{class:"fa-solid fa-plus"},null,-1),t("span",{class:"hidden sm:inline"},"สร้างผู้ใช้ใหม่",-1)]))]),t("div",ve,[g(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>i.q=s),onKeyup:le(B,["enter"]),type:"text",placeholder:"ค้นหา : Email / User / Name",class:"max-w-full px-3 py-2 border border-gray-300 rounded-md w-72 focus:outline-none focus:ring-2 focus:ring-blue-500"},null,544),[[k,i.q,void 0,{trim:!0}]]),t("button",{onClick:B,class:"px-4 py-2 text-white bg-blue-600 rounded-md cursor-pointer hover:bg-blue-700"}," ค้นหา ")])]),t("div",he,[t("div",we,[t("div",_e,[e[12]||(e[12]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"จุดเริ่มต้น",-1)),g(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>i.startName=s),type:"text",placeholder:"ชื่อสถานที่เริ่มต้น (ใช้ key: name)",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},null,512),[[k,i.startName]])]),t("div",ke,[e[13]||(e[13]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"ปลายทาง",-1)),g(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>i.endName=s),type:"text",placeholder:"ชื่อปลายทาง (ใช้ key: name)",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},null,512),[[k,i.endName]])]),t("div",Ae,[e[15]||(e[15]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"สถานะ",-1)),g(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>i.status=s),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},e[14]||(e[14]=[t("option",{value:""},"ทั้งหมด",-1),t("option",{value:"AVAILABLE"},"AVAILABLE",-1),t("option",{value:"FULL"},"FULL",-1)]),512),[[V,i.status]])]),t("div",Le,[e[16]||(e[16]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"ออกเดินทางตั้งแต่ (YYYY-MM-DD)",-1)),g(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>i.departureFrom=s),type:"date",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},null,512),[[k,i.departureFrom]])]),t("div",Be,[e[17]||(e[17]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"ถึงวันที่",-1)),g(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>i.departureTo=s),type:"date",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},null,512),[[k,i.departureTo]])]),t("div",Ce,[e[19]||(e[19]=t("label",{class:"block mb-1 text-xs font-medium text-gray-600"},"เรียงตาม",-1)),g(t("select",{"onUpdate:modelValue":e[6]||(e[6]=s=>i.sort=s),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500"},e[18]||(e[18]=[re('<option value="">(ค่าเริ่มต้น)</option><option value="departureTime:desc">departureTime desc</option><option value="departureTime:asc">departureTime asc</option><option value="createdAt:desc">createdAt desc</option><option value="createdAt:asc">createdAt asc</option><option value="updatedAt:desc">updatedAt desc</option><option value="updatedAt:asc">updatedAt asc</option>',7)]),512),[[V,i.sort]])]),t("div",{class:"flex items-end justify-end gap-2 mt-1 lg:col-span-4 lg:mt-0"},[t("button",{onClick:J,class:"px-3 py-2 text-gray-700 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50"}," ล้างตัวกรอง "),t("button",{onClick:B,class:"px-4 py-2 text-white bg-blue-600 rounded-md cursor-pointer hover:bg-blue-700"}," ใช้ตัวกรอง ")])])]),t("div",Ee,[t("div",Ie,[t("div",Ue," หน้าที่ "+c(l.page)+" / "+c(w.value)+" • ทั้งหมด "+c(l.total)+" ผู้ใช้ ",1)]),f.value?(p(),u("div",Ve,"กำลังโหลดข้อมูล...")):h.value?(p(),u("div",$e,c(h.value),1)):(p(),u("div",Me,[t("table",Ne,[e[25]||(e[25]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"},"ผู้ใช้ "),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"},"อีเมล "),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"}," ชื่อผู้ใช้"),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"},"บทบาท "),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"}," ยืนยันตัวตน"),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"},"สถานะ "),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"}," สร้างเมื่อ"),t("th",{class:"px-4 py-3 text-xs font-medium text-left text-gray-500 uppercase"},"การกระทำ ")])],-1)),t("tbody",Te,[(p(!0),u(M,null,q(L.value,s=>(p(),u("tr",{key:s.id,class:A(["transition-opacity hover:bg-gray-50",s.isActive?"":"opacity-60"])},[t("td",Se,[t("div",ze,[t("img",{src:s.profilePicture||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.firstName||"U")}&background=random&size=64`,class:"object-cover rounded-full w-9 h-9",alt:"avatar"},null,8,De),t("div",null,[t("div",Re,c(s.firstName)+" "+c(s.lastName),1),t("div",je,c(s.gender||"-"),1)])])]),t("td",Fe,c(s.email),1),t("td",He,c(s.username),1),t("td",qe,[t("span",{class:A(["inline-flex items-center px-2 py-1 text-xs font-medium rounded-full",Y(s.role)])},[s.role==="ADMIN"?(p(),u("i",Pe)):$("",!0),P(" "+c(s.role),1)],2)]),t("td",Oe,[t("span",{class:A(["inline-flex items-center px-2 py-1 text-xs font-medium rounded-full",s.isVerified?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"])},[s.isVerified?(p(),u("i",Ye)):$("",!0),P(" "+c(s.isVerified?"ยืนยันแล้ว":"ยังไม่ยืนยัน"),1)],2)]),t("td",Ge,[t("div",Je,[t("label",Ke,[t("input",{type:"checkbox",class:"switch-input",checked:s.isActive,disabled:f.value||C.value.has(s.id),onChange:r=>W(s,r.target.checked)},null,40,We),e[20]||(e[20]=t("span",{class:"switch-slider"},null,-1))]),t("span",{class:A(["ml-2 text-sm",s.isActive?"text-green-700":"text-gray-500"])},c(s.isActive?"Active":"Inactive"),3)])]),t("td",Qe,[t("div",Xe,c(D(s.createdAt)),1),t("div",Ze,"อัปเดต "+c(D(s.updatedAt)),1)]),t("td",et,[t("button",{onClick:r=>te(s),class:"p-2 text-gray-500 transition-colors cursor-pointer hover:text-emerald-600",title:"ดูรายละเอียด","aria-label":"ดูรายละเอียด"},e[21]||(e[21]=[t("i",{class:"text-lg fa-regular fa-eye"},null,-1)]),8,tt),t("button",{onClick:r=>K(s),class:"p-2 text-gray-500 transition-colors cursor-pointer hover:text-blue-600",title:"แก้ไข","aria-label":"แก้ไข"},e[22]||(e[22]=[t("i",{class:"text-lg fa-regular fa-pen-to-square"},null,-1)]),8,st),t("button",{onClick:r=>Q(s),class:"p-2 text-gray-500 transition-colors cursor-pointer hover:text-red-600",title:"ลบ","aria-label":"ลบ"},e[23]||(e[23]=[t("i",{class:"text-lg fa-regular fa-trash-can"},null,-1)]),8,ot)])],2))),128)),L.value.length?$("",!0):(p(),u("tr",at,e[24]||(e[24]=[t("td",{colspan:"8",class:"px-4 py-10 text-center text-gray-500"},"ไม่มีข้อมูลผู้ใช้",-1)])))])])])),t("div",nt,[t("div",it,[t("div",lt,[e[27]||(e[27]=t("span",{class:"text-xs text-gray-500"},"Limit:",-1)),g(t("select",{"onUpdate:modelValue":e[7]||(e[7]=s=>l.limit=s),onChange:B,class:"px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500"},e[26]||(e[26]=[t("option",{value:10},"10",-1),t("option",{value:20},"20",-1),t("option",{value:50},"50",-1)]),544),[[V,l.limit,void 0,{number:!0}]])])]),t("nav",rt,[t("button",{class:"px-3 py-2 text-sm border rounded-md disabled:opacity-50",disabled:l.page<=1||f.value,onClick:e[8]||(e[8]=s=>E(l.page-1))}," Previous ",8,dt),(p(!0),u(M,null,q(O.value,(s,r)=>(p(),u(M,{key:`p-${r}-${s}`},[s==="…"?(p(),u("span",ct,"…")):(p(),u("button",{key:1,class:A(["px-3 py-2 text-sm border rounded-md",s===l.page?"bg-blue-50 text-blue-600 border-blue-200":"hover:bg-gray-50"]),disabled:f.value,onClick:n=>E(s)},c(s),11,ut))],64))),128)),t("button",{class:"px-3 py-2 text-sm border rounded-md disabled:opacity-50",disabled:l.page>=w.value||f.value,onClick:e[9]||(e[9]=s=>E(l.page+1))}," Next ",8,pt)])])])])]),t("div",{id:"overlay",class:"fixed inset-0 z-40 hidden bg-black bg-opacity-50 lg:hidden",onClick:se}),U(ge,{show:I.value,title:`ลบผู้ใช้${(a=y.value)!=null&&a.email?" : "+y.value.email:""}`,message:"การลบนี้เป็นการลบถาวร ข้อมูลทั้งหมดจะถูกลบและไม่สามารถกู้คืนได้ คุณต้องการดำเนินการต่อหรือไม่?",confirmText:"ลบถาวร",cancelText:"ยกเลิก",variant:"danger",onConfirm:X,onCancel:j},null,8,["show","title"])])}}};export{kt as default};
