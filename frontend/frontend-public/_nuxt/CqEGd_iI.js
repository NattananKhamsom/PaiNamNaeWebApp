import{_ as ae,m as ne,r as y,x as J,y as le,i as ie,c as l,a as s,b as re,F as k,q as C,g as v,o as i,n as Q,t as c,f as X,s as de}from"./DPSIKoxe.js";import{d as A}from"./B5yDJBm8.js";import{b as ce}from"./C5FTVxxA.js";import{C as ue}from"./CL2Ezi0q.js";import{s as me}from"./x_rD_Ya3.js";import{u as ge}from"./BaxiziUg.js";import"./Cpj98o6Y.js";const ve={class:"px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8"},pe={class:"p-6 mb-8 bg-white border border-gray-300 rounded-lg shadow-md"},fe={class:"flex flex-wrap gap-2"},_e=["onClick"],ye={class:"grid grid-cols-1 gap-6 lg:grid-cols-3"},he={class:"lg:col-span-2"},xe={class:"bg-white border border-gray-300 rounded-lg shadow-md"},be={key:0,class:"p-12 text-center text-gray-500"},we={key:1,class:"divide-y divide-gray-200"},ke={key:0,class:"p-12 text-center text-gray-500"},Ce=["onClick"],Me={class:"flex items-start justify-between mb-4"},$e={class:"flex-1"},Ne={class:"flex items-center justify-between"},Te={class:"text-lg font-semibold text-gray-900"},Pe={key:0,class:"status-badge status-pending"},Ae={key:1,class:"status-badge status-confirmed"},Be={key:2,class:"status-badge status-rejected"},je={key:3,class:"status-badge status-cancelled"},Le={class:"mt-1 text-sm text-gray-600"},Se={class:"text-sm text-gray-600"},De={class:"flex items-center mb-4 space-x-4"},Fe=["src","alt"],He={class:"flex-1"},Ve={class:"font-medium text-gray-900"},Ee={class:"flex items-center"},Oe={class:"flex text-sm text-yellow-400"},ze={class:"ml-2 text-sm text-gray-600"},Ie={class:"text-right"},Ge={class:"text-lg font-bold text-blue-600"},Ke={class:"text-sm text-gray-600"},Ue={key:0,class:"pt-4 mt-4 mb-5 duration-300 border-t border-gray-300 animate-in slide-in-from-top"},qe={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},Re={class:"space-y-1 text-sm text-gray-600"},We={key:0},Je={key:1},Qe={class:"space-y-1 text-sm text-gray-600"},Xe={class:"mt-4 space-y-4"},Ye={key:0},Ze={class:"p-3 text-sm text-gray-700 border border-gray-300 rounded-md bg-gray-50"},et={key:1},tt={class:"grid grid-cols-3 gap-2 mt-2"},st=["src"],ot=["onClick"],at={key:1,class:"px-4 py-2 text-sm text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700"},nt=["onClick"],lt={class:"lg:col-span-1"},it={class:"sticky overflow-hidden bg-white border border-gray-300 rounded-lg shadow-md top-8"},Y="__gmapsReady__",rt={__name:"index_v2",setup(dt){var W;A.locale("th"),A.extend(ce);const{$api:z}=ne(),{toast:I}=de(),M=y("pending"),x=y(null),B=y(!1),j=y(null),u=y([]);let p=null,$=null,N=null,T=null,L=null,S=null;const D=y(!1),Z=[{status:"pending",label:"รอดำเนินการ"},{status:"confirmed",label:"ยืนยันแล้ว"},{status:"rejected",label:"ปฏิเสธ"},{status:"cancelled",label:"ยกเลิก"},{status:"all",label:"ทั้งหมด"}],b=J(()=>M.value==="all"?u.value:u.value.filter(o=>o.status===M.value));J(()=>u.value.find(o=>o.id===x.value)||null);async function F(){B.value=!0;try{const a=(await z("/bookings/me")).map(t=>{var g,w;const r={name:`${t.route.driver.firstName} ${t.route.driver.lastName}`.trim(),image:t.route.driver.profilePicture||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.route.driver.firstName||"U")}&background=random&size=64`,rating:4.5,reviews:Math.floor(Math.random()*50)+5},m=[];t.route.vehicle?(m.push(`${t.route.vehicle.vehicleModel} (${t.route.vehicle.vehicleType})`),Array.isArray(t.route.vehicle.amenities)&&t.route.vehicle.amenities.length&&m.push(...t.route.vehicle.amenities)):m.push("ไม่มีข้อมูลรถ");const n=t.route.startLocation,d=t.route.endLocation;return{id:t.id,status:String(t.status||"").toLowerCase(),origin:(n==null?void 0:n.name)||`(${Number(n.lat).toFixed(2)}, ${Number(n.lng).toFixed(2)})`,destination:(d==null?void 0:d.name)||`(${Number(d.lat).toFixed(2)}, ${Number(d.lng).toFixed(2)})`,originAddress:(n==null?void 0:n.address)||null,destinationAddress:(d==null?void 0:d.address)||null,originHasName:!!(n!=null&&n.name),destinationHasName:!!(d!=null&&d.name),pickupPoint:((g=t.pickupLocation)==null?void 0:g.name)||"-",date:A(t.route.departureTime).format("D MMMM BBBB"),time:A(t.route.departureTime).format("HH:mm น."),price:(t.route.pricePerSeat||0)*(t.numberOfSeats||1),seats:t.numberOfSeats||1,driver:r,coords:[[n.lat,n.lng],[d.lat,d.lng]],polyline:t.route.routePolyline||null,stops:["ไม่มีข้อมูลจุดแวะพัก"],carDetails:m,conditions:t.route.conditions,photos:((w=t.route.vehicle)==null?void 0:w.photos)||[]}});u.value=a,await G();const e=u.value.map(async(t,r)=>{const[m,n]=await Promise.all([K(t.coords[0][0],t.coords[0][1]),K(t.coords[1][0],t.coords[1][1])]),d=await U(m),g=await U(n);!u.value[r].originHasName&&d.name&&(u.value[r].origin=d.name),!u.value[r].destinationHasName&&g.name&&(u.value[r].destination=g.name)});await Promise.allSettled(e)}catch(o){console.error("Failed to fetch my trips:",o),u.value=[]}finally{B.value=!1}}function G(){return new Promise(o=>{if(D.value)return o(!0);const a=me(()=>{D.value&&(clearInterval(a),o(!0))},50)})}function K(o,a){return new Promise(e=>{if(!L)return e(null);L.geocode({location:{lat:o,lng:a}},(t,r)=>{if(r!=="OK"||!(t!=null&&t.length))return e(null);e(t[0])})})}async function U(o){if(!o)return{name:null,area:null};const a=o.address_components||[],e=f=>{var _;return(_=a.find(O=>O.types.includes(f)))==null?void 0:_.long_name},t=f=>{var _;return(_=a.find(O=>O.types.includes(f)))==null?void 0:_.short_name},r=o.types||[],m=r.includes("point_of_interest")||r.includes("establishment")||r.includes("premise");let n=null;if(m&&o.place_id){const f=await ee(o.place_id);f&&(n=f)}if(!n){const f=e("street_number"),_=e("route");n=f&&_?`${f} ${_}`:_||o.formatted_address||null}const d=e("sublocality")||e("neighborhood")||e("locality")||e("administrative_area_level_2"),g=e("administrative_area_level_1")||t("administrative_area_level_1");let w=null;return d&&g?w=`${d}, ${g}`:g&&(w=g),n&&(n=n.replace(/,?\s*(Thailand|ไทย)\s*$/i,"")),{name:n,area:w}}function ee(o){return new Promise(a=>{if(!S||!o)return a(null);S.getDetails({placeId:o,fields:["name"]},(e,t)=>{t===google.maps.places.PlacesServiceStatus.OK&&(e!=null&&e.name)?a(e.name):a(null)})})}const te=o=>o==="all"?u.value.length:u.value.filter(a=>a.status===o).length,se=o=>{const a=u.value.find(e=>e.id===o);a&&H(a),x.value===o?x.value=null:x.value=o};async function H(o){var t;if(!o||(await G(),!p))return;$&&($.setMap(null),$=null),N&&(N.setMap(null),N=null),T&&(T.setMap(null),T=null);const a={lat:Number(o.coords[0][0]),lng:Number(o.coords[0][1])},e={lat:Number(o.coords[1][0]),lng:Number(o.coords[1][1])};if(N=new google.maps.Marker({position:a,map:p,label:"A"}),T=new google.maps.Marker({position:e,map:p,label:"B"}),o.polyline&&((t=google.maps.geometry)!=null&&t.encoding)){const r=google.maps.geometry.encoding.decodePath(o.polyline);$=new google.maps.Polyline({path:r,map:p,strokeColor:"#2563eb",strokeOpacity:.9,strokeWeight:5});const m=new google.maps.LatLngBounds;r.forEach(n=>m.extend(n)),p.fitBounds(m)}else{const r=new google.maps.LatLngBounds;r.extend(a),r.extend(e),p.fitBounds(r)}}const V=y(!1),P=y(null),h=y({title:"",message:"",confirmText:"",action:null,variant:"danger"}),q=(o,a)=>{P.value=o,a==="cancel"?h.value={title:"ยืนยันการยกเลิกการจอง",message:`คุณต้องการยกเลิกการเดินทางไปที่ "${o.destination}" ใช่หรือไม่?`,confirmText:"ใช่, ยกเลิกการจอง",action:"cancel",variant:"danger"}:a==="delete"&&(h.value={title:"ยืนยันการลบรายการ",message:`คุณต้องการลบรายการเดินทางไปที่ "${o.destination}" ออกจากประวัติใช่หรือไม่?`,confirmText:"ใช่, ลบรายการ",action:"delete",variant:"danger"}),V.value=!0},E=()=>{V.value=!1,P.value=null},oe=async()=>{var e;if(!P.value)return;const o=h.value.action,a=P.value.id;try{o==="cancel"?(await z(`/bookings/${a}/cancel`,{method:"PATCH",body:{status:"CANCELLED"}}),I.success("ยกเลิกการจองสำเร็จ","การจองของคุณถูกยกเลิกแล้ว")):o==="delete"&&console.log(`Deleting booking ID: ${a}`),E(),await F()}catch(t){console.error(`Failed to ${o} booking:`,t),I.error("เกิดข้อผิดพลาด",((e=t.data)==null?void 0:e.message)||"ไม่สามารถดำเนินการได้"),E()}};ge({script:(W=window.google)!=null&&W.maps?[]:[{key:"gmaps",src:`https://maps.googleapis.com/maps/api/js?key=${le().public.googleMapsApiKey}&libraries=places,geometry&callback=__gmapsReady__`,async:!0,defer:!0}]}),ie(()=>{var o;if((o=window.google)!=null&&o.maps){R(),F().then(()=>{b.value.length&&H(b.value[0])});return}window[Y]=()=>{try{delete window[Y]}catch{}R(),F().then(()=>{b.value.length&&H(b.value[0])})}});function R(){!j.value||p||(p=new google.maps.Map(j.value,{center:{lat:13.7563,lng:100.5018},zoom:6,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!0}),L=new google.maps.Geocoder,S=new google.maps.places.PlacesService(p),D.value=!0)}return(o,a)=>(i(),l("div",null,[s("div",ve,[a[8]||(a[8]=s("div",{class:"mb-8"},[s("h2",{class:"text-2xl font-bold text-gray-900"},"การเดินทางของฉัน"),s("p",{class:"mt-2 text-gray-600"},"จัดการและติดตามการเดินทางทั้งหมดของคุณ")],-1)),s("div",pe,[s("div",fe,[(i(),l(k,null,C(Z,e=>s("button",{key:e.status,onClick:t=>M.value=e.status,class:Q(["tab-button px-4 py-2 rounded-md font-medium",{active:M.value===e.status}])},c(e.label)+" ("+c(te(e.status))+") ",11,_e)),64))])]),s("div",ye,[s("div",he,[s("div",xe,[a[6]||(a[6]=s("div",{class:"p-6 border-b border-gray-300"},[s("h3",{class:"text-lg font-semibold text-gray-900"},"รายการการเดินทาง")],-1)),B.value?(i(),l("div",be,a[0]||(a[0]=[s("p",null,"กำลังโหลดข้อมูลการเดินทาง...",-1)]))):(i(),l("div",we,[b.value.length===0?(i(),l("div",ke,a[1]||(a[1]=[s("p",null,"ไม่พบรายการเดินทางในหมวดหมู่นี้",-1)]))):v("",!0),(i(!0),l(k,null,C(b.value,e=>(i(),l("div",{key:e.id,class:"p-6 transition-colors duration-200 cursor-pointer trip-card hover:bg-gray-50",onClick:t=>se(e.id)},[s("div",Me,[s("div",$e,[s("div",Ne,[s("h4",Te,c(e.origin)+" → "+c(e.destination),1),e.status==="pending"?(i(),l("span",Pe,"รอดำเนินการ")):e.status==="confirmed"?(i(),l("span",Ae,"ยืนยันแล้ว")):e.status==="rejected"?(i(),l("span",Be,"ปฏิเสธ")):e.status==="cancelled"?(i(),l("span",je,"ยกเลิก")):v("",!0)]),s("p",Le,"จุดนัดพบ: "+c(e.pickupPoint),1),s("p",Se,"วันที่: "+c(e.date)+" เวลา: "+c(e.time),1)])]),s("div",De,[s("img",{src:e.driver.image,alt:e.driver.name,class:"object-cover w-12 h-12 rounded-full"},null,8,Fe),s("div",He,[s("h5",Ve,c(e.driver.name),1),s("div",Ee,[s("div",Oe,[s("span",null,c("★".repeat(Math.round(e.driver.rating)))+c("☆".repeat(5-Math.round(e.driver.rating))),1)]),s("span",ze,c(e.driver.rating)+" ("+c(e.driver.reviews)+" รีวิว)",1)])]),s("div",Ie,[s("div",Ge,c(e.price)+" บาท",1),s("div",Ke,"จำนวน "+c(e.seats)+" ที่นั่ง",1)])]),x.value===e.id?(i(),l("div",Ue,[s("div",qe,[s("div",null,[a[2]||(a[2]=s("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดเส้นทาง",-1)),s("ul",Re,[e.originAddress?(i(),l("li",We,"• จุดเริ่มต้น (ที่อยู่): "+c(e.originAddress),1)):v("",!0),e.destinationAddress?(i(),l("li",Je,"• จุดปลายทาง (ที่อยู่): "+c(e.destinationAddress),1)):v("",!0),(i(!0),l(k,null,C(e.stops,t=>(i(),l("li",{key:t},"• "+c(t),1))),128))])]),s("div",null,[a[3]||(a[3]=s("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดรถ",-1)),s("ul",Qe,[(i(!0),l(k,null,C(e.carDetails,t=>(i(),l("li",{key:t},"• "+c(t),1))),128))])])]),s("div",Xe,[e.conditions?(i(),l("div",Ye,[a[4]||(a[4]=s("h5",{class:"mb-2 font-medium text-gray-900"},"เงื่อนไขการเดินทาง",-1)),s("p",Ze,c(e.conditions),1)])):v("",!0),e.photos&&e.photos.length>0?(i(),l("div",et,[a[5]||(a[5]=s("h5",{class:"mb-2 font-medium text-gray-900"},"รูปภาพรถยนต์",-1)),s("div",tt,[(i(!0),l(k,null,C(e.photos.slice(0,3),(t,r)=>(i(),l("div",{key:r},[s("img",{src:t,alt:"Vehicle photo",class:"object-cover w-full transition-opacity rounded-lg shadow-sm cursor-pointer aspect-video hover:opacity-90"},null,8,st)]))),128))])])):v("",!0)])])):v("",!0),s("div",{class:Q(["flex justify-end space-x-3",{"mt-4":x.value!==e.id}])},[e.status==="pending"?(i(),l("button",{key:0,onClick:X(t=>q(e,"cancel"),["stop"]),class:"px-4 py-2 text-sm text-red-600 transition duration-200 border border-red-300 rounded-md hover:bg-red-50"}," ยกเลิกการจอง ",8,ot)):v("",!0),e.status==="confirmed"?(i(),l("button",at," แชทกับผู้ขับ ")):v("",!0),["rejected","cancelled"].includes(e.status)?(i(),l("button",{key:2,onClick:X(t=>q(e,"delete"),["stop"]),class:"px-4 py-2 text-sm text-gray-600 transition duration-200 border border-gray-300 rounded-md hover:bg-gray-50"}," ลบรายการ ",8,nt)):v("",!0)],2)],8,Ce))),128))]))])]),s("div",lt,[s("div",it,[a[7]||(a[7]=s("div",{class:"p-6 border-b border-gray-300"},[s("h3",{class:"text-lg font-semibold text-gray-900"},"แผนที่เส้นทาง")],-1)),s("div",{ref_key:"mapContainer",ref:j,id:"map",class:"h-96"},null,512)])])])]),re(ue,{show:V.value,title:h.value.title,message:h.value.message,confirmText:h.value.confirmText,variant:h.value.variant,onConfirm:oe,onCancel:E},null,8,["show","title","message","confirmText","variant"])]))}},_t=ae(rt,[["__scopeId","data-v-2a07cd2d"]]);export{_t as default};
