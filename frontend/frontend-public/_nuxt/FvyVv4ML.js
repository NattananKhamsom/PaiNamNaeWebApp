import{_ as me,m as ge,r as b,x as oe,y as pe,i as fe,p as ve,c as n,a as t,b as ye,F as T,q as N,g as v,t as r,s as he,o as l,n as ae,d as P,f as A}from"./DPSIKoxe.js";import{d as H}from"./B5yDJBm8.js";import{b as xe}from"./C5FTVxxA.js";import{C as be}from"./CL2Ezi0q.js";import{s as _e}from"./x_rD_Ya3.js";import{u as ke}from"./BaxiziUg.js";import"./Cpj98o6Y.js";const we={class:"px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8"},Ce={class:"p-6 mb-8 bg-white border border-gray-300 rounded-lg shadow-md"},Me={class:"flex flex-wrap gap-2"},Te=["onClick"],$e={class:"grid grid-cols-1 gap-6 lg:grid-cols-3"},Ne={class:"lg:col-span-2"},Pe={class:"bg-white border border-gray-300 rounded-lg shadow-md"},Ae={key:0,class:"p-12 text-center text-gray-500"},je={key:1,class:"divide-y divide-gray-200"},Be={key:0,class:"p-12 text-center text-gray-500"},Le=["onClick"],Se={class:"flex items-start justify-between mb-4"},Ve={class:"flex-1"},De={class:"flex items-center justify-between"},Fe={class:"text-lg font-semibold text-gray-900"},He={key:0,class:"status-badge status-pending"},Ee={key:1,class:"status-badge status-confirmed"},Oe={key:2,class:"status-badge status-rejected"},ze={key:3,class:"status-badge status-cancelled"},Ie={class:"mt-1 text-sm text-gray-600"},Ge={class:"text-sm text-gray-600"},Ke={class:"flex items-center mb-4 space-x-4"},Re=["src","alt"],qe={class:"flex-1"},Je={class:"flex items-center"},Ue={class:"font-medium text-gray-900"},We={key:0,class:"relative group ml-1.5 flex items-center"},Qe={class:"flex"},Xe={key:0,class:"text-xs text-gray-500 mt-0.5"},Ye=["href"],Ze=["onClick"],et={class:"flex items-center mt-1"},tt={class:"flex text-sm text-yellow-400"},st={class:"ml-2 text-sm text-gray-600"},ot={class:"text-right"},at={class:"text-lg font-bold text-blue-600"},nt={class:"text-sm text-gray-600"},lt={key:0,class:"pt-4 mt-4 mb-5 duration-300 border-t border-gray-300 animate-in slide-in-from-top"},it={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},rt={class:"space-y-1 text-sm text-gray-600"},dt={key:0},ct={key:1},ut={class:"space-y-1 text-sm text-gray-600"},mt={class:"mt-4 space-y-4"},gt={key:0},pt={class:"p-3 text-sm text-gray-700 border border-gray-300 rounded-md bg-gray-50"},ft={key:1},vt={class:"grid grid-cols-3 gap-2 mt-2"},yt=["src"],ht=["onClick"],xt=["onClick"],bt={key:1,class:"px-4 py-2 text-sm text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700"},_t=["onClick"],kt={class:"lg:col-span-1"},wt={class:"sticky overflow-hidden bg-white border border-gray-300 rounded-lg shadow-md top-8"},Ct={class:"p-3 border-gray-300"},Mt={class:"mt-1 text-sm text-gray-600"},Q="__gmapsReady__",Tt={__name:"index_v3",setup($t){var te;H.locale("th"),H.extend(xe);const{$api:E}=ge(),{toast:w}=he(),$=b("pending"),C=b(null),O=b(!1),z=b(null),g=b([]);let y=null,j=null,B=null,L=null,I=null,G=null;const K=b(!1),ne=[{status:"pending",label:"รอดำเนินการ"},{status:"confirmed",label:"ยืนยันแล้ว"},{status:"rejected",label:"ปฏิเสธ"},{status:"cancelled",label:"ยกเลิก"},{status:"all",label:"ทั้งหมด"}],_=oe(()=>$.value==="all"?g.value:g.value.filter(o=>o.status===$.value)),R=oe(()=>g.value.find(o=>o.id===C.value)||null);async function q(){var o,s,e,a,d,p,f,h,D;O.value=!0;try{const M=await E("/routes/me"),se=[];for(const i of M){const x=[];i.vehicle?(x.push(`${i.vehicle.vehicleModel} (${i.vehicle.vehicleType})`),Array.isArray(i.vehicle.amenities)&&i.vehicle.amenities.length>0&&x.push(...i.vehicle.amenities)):x.push("ไม่มีข้อมูลรถ");const c=i.startLocation,u=i.endLocation,F=[[c.lat,c.lng],[u.lat,u.lng]];for(const m of i.bookings||[])se.push({id:m.id,status:(m.status||"").toLowerCase(),origin:(c==null?void 0:c.name)||`(${Number(c.lat).toFixed(2)}, ${Number(c.lng).toFixed(2)})`,destination:(u==null?void 0:u.name)||`(${Number(u.lat).toFixed(2)}, ${Number(u.lng).toFixed(2)})`,originHasName:!!(c!=null&&c.name),destinationHasName:!!(u!=null&&u.name),pickupPoint:((o=m.pickupLocation)==null?void 0:o.name)||"-",date:H(i.departureTime).format("D MMMM BBBB"),time:H(i.departureTime).format("HH:mm น."),price:(i.pricePerSeat||0)*(m.numberOfSeats||0),seats:m.numberOfSeats||0,passenger:{name:`${((s=m.passenger)==null?void 0:s.firstName)||""} ${((e=m.passenger)==null?void 0:e.lastName)||""}`.trim()||"ผู้โดยสาร",image:((a=m.passenger)==null?void 0:a.profilePicture)||`https://ui-avatars.com/api/?name=${encodeURIComponent(((d=m.passenger)==null?void 0:d.firstName)||"P")}&background=random&size=64`,email:((p=m.passenger)==null?void 0:p.email)||"",isVerified:!!((f=m.passenger)!=null&&f.isVerified),rating:4.5,reviews:Math.floor(Math.random()*50)+5},coords:F,polyline:i.routePolyline||null,stops:["ไม่มีข้อมูลจุดแวะพัก"],carDetails:x,conditions:i.conditions,photos:((h=i.vehicle)==null?void 0:h.photos)||[],originAddress:(c==null?void 0:c.address)||null,destinationAddress:(u==null?void 0:u.address)||null,durationText:i.duration||(i.durationSeconds?`${Math.round(i.durationSeconds/60)} นาที`:"-"),distanceText:i.distance||(i.distanceMeters?`${(i.distanceMeters/1e3).toFixed(1)} กม.`:"-")})}g.value=se,await X();const ue=g.value.map(async(i,x)=>{const[c,u]=await Promise.all([Y(i.coords[0][0],i.coords[0][1]),Y(i.coords[1][0],i.coords[1][1])]),F=await Z(c),m=await Z(u);!g.value[x].originHasName&&F.name&&(g.value[x].origin=F.name),!g.value[x].destinationHasName&&m.name&&(g.value[x].destination=m.name)});await Promise.allSettled(ue)}catch(M){console.error("Failed to fetch routes:",M),g.value=[],w.error("เกิดข้อผิดพลาด",((D=M==null?void 0:M.data)==null?void 0:D.message)||"ไม่สามารถโหลดข้อมูลได้")}finally{O.value=!1}}const le=o=>o==="all"?g.value.length:g.value.filter(s=>s.status===o).length,ie=o=>{const s=g.value.find(e=>e.id===o);s&&S(s),C.value=C.value===o?null:o};function X(){return new Promise(o=>{if(K.value)return o(!0);const s=_e(()=>{K.value&&(clearInterval(s),o(!0))},50)})}function Y(o,s){return new Promise(e=>{if(!I)return e(null);I.geocode({location:{lat:o,lng:s}},(a,d)=>{if(d!=="OK"||!(a!=null&&a.length))return e(null);e(a[0])})})}async function Z(o){if(!o)return{name:null,area:null};const s=o.address_components||[],e=f=>{var h;return(h=s.find(D=>D.types.includes(f)))==null?void 0:h.long_name},a=o.types||[],d=a.includes("point_of_interest")||a.includes("establishment")||a.includes("premise");let p=null;if(d&&o.place_id){const f=await re(o.place_id);f&&(p=f)}if(!p){const f=e("street_number"),h=e("route");p=f&&h?`${f} ${h}`:h||o.formatted_address||null}return p&&(p=p.replace(/,?\s*(Thailand|ไทย)\s*$/i,"")),{name:p}}function re(o){return new Promise(s=>{if(!G||!o)return s(null);G.getDetails({placeId:o,fields:["name"]},(e,a)=>{a===google.maps.places.PlacesServiceStatus.OK&&(e!=null&&e.name)?s(e.name):s(null)})})}async function S(o){var a;if(!o||(await X(),!y))return;j&&(j.setMap(null),j=null),B&&(B.setMap(null),B=null),L&&(L.setMap(null),L=null);const s={lat:Number(o.coords[0][0]),lng:Number(o.coords[0][1])},e={lat:Number(o.coords[1][0]),lng:Number(o.coords[1][1])};if(B=new google.maps.Marker({position:s,map:y,label:"A"}),L=new google.maps.Marker({position:e,map:y,label:"B"}),o.polyline&&((a=google.maps.geometry)!=null&&a.encoding)){const d=google.maps.geometry.encoding.decodePath(o.polyline);j=new google.maps.Polyline({path:d,map:y,strokeColor:"#2563eb",strokeOpacity:.9,strokeWeight:5});const p=new google.maps.LatLngBounds;d.forEach(f=>p.extend(f)),y.fitBounds(p)}else{const d=new google.maps.LatLngBounds;d.extend(s),d.extend(e),y.fitBounds(d)}}const J=b(!1),V=b(null),k=b({title:"",message:"",confirmText:"",action:null,variant:"danger"}),U=(o,s)=>{V.value=o,s==="confirm"?k.value={title:"ยืนยันคำขอจอง",message:`ยืนยันคำขอของผู้โดยสาร "${o.passenger.name}" ใช่หรือไม่?`,confirmText:"ยืนยันคำขอ",action:"confirm",variant:"primary"}:s==="reject"?k.value={title:"ปฏิเสธคำขอจอง",message:`ต้องการปฏิเสธคำขอของ "${o.passenger.name}" ใช่หรือไม่?`,confirmText:"ปฏิเสธ",action:"reject",variant:"danger"}:s==="delete"&&(k.value={title:"ยืนยันการลบรายการ",message:"ต้องการลบคำขอนี้ออกจากรายการใช่หรือไม่?",confirmText:"ลบรายการ",action:"delete",variant:"danger"}),J.value=!0},W=()=>{J.value=!1,V.value=null},de=async()=>{var e;if(!V.value)return;const o=k.value.action,s=V.value.id;try{o==="confirm"?(await E(`/bookings/${s}/status`,{method:"PATCH",body:{status:"CONFIRMED"}}),w.success("สำเร็จ","ยืนยันคำขอแล้ว")):o==="reject"?(await E(`/bookings/${s}/status`,{method:"PATCH",body:{status:"REJECTED"}}),w.success("สำเร็จ","ปฏิเสธคำขอแล้ว")):o==="delete"&&console.log(`Delete booking ${s} (TODO)`),W(),await q()}catch(a){console.error(`Failed to ${o} booking:`,a),w.error("เกิดข้อผิดพลาด",((e=a==null?void 0:a.data)==null?void 0:e.message)||"ไม่สามารถดำเนินการได้"),W()}},ce=async o=>{try{await navigator.clipboard.writeText(o),w.success("คัดลอกแล้ว",o)}catch{w.error("คัดลอกไม่สำเร็จ","ลองใหม่อีกครั้ง")}};ke({script:(te=window.google)!=null&&te.maps?[]:[{key:"gmaps",src:`https://maps.googleapis.com/maps/api/js?key=${pe().public.googleMapsApiKey}&libraries=places,geometry&callback=${Q}`,async:!0,defer:!0}]}),fe(()=>{var o;if((o=window.google)!=null&&o.maps){ee(),q().then(()=>{_.value.length&&S(_.value[0])});return}window[Q]=()=>{try{delete window[Q]}catch{}ee(),q().then(()=>{_.value.length&&S(_.value[0])})}});function ee(){!z.value||y||(y=new google.maps.Map(z.value,{center:{lat:13.7563,lng:100.5018},zoom:6,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!0}),I=new google.maps.Geocoder,G=new google.maps.places.PlacesService(y),K.value=!0)}return ve($,()=>{C.value=null,_.value.length>0&&S(_.value[0])}),(o,s)=>(l(),n("div",null,[t("div",we,[s[15]||(s[15]=t("div",{class:"mb-8"},[t("h2",{class:"text-2xl font-bold text-gray-900"},"คำขอจองเส้นทางของฉัน"),t("p",{class:"mt-2 text-gray-600"},"ดูและจัดการคำขอจองจากผู้โดยสารในเส้นทางที่คุณสร้าง")],-1)),t("div",Ce,[t("div",Me,[(l(),n(T,null,N(ne,e=>t("button",{key:e.status,onClick:a=>$.value=e.status,class:ae(["tab-button px-4 py-2 rounded-md font-medium",{active:$.value===e.status}])},r(e.label)+" ("+r(le(e.status))+") ",11,Te)),64))])]),t("div",$e,[t("div",Ne,[t("div",Pe,[s[13]||(s[13]=t("div",{class:"p-6 border-b border-gray-300"},[t("h3",{class:"text-lg font-semibold text-gray-900"},"รายการคำขอจอง")],-1)),O.value?(l(),n("div",Ae,s[1]||(s[1]=[t("p",null,"กำลังโหลดข้อมูล...",-1)]))):(l(),n("div",je,[_.value.length===0?(l(),n("div",Be,s[2]||(s[2]=[t("p",null,"ไม่พบรายการในหมวดหมู่นี้",-1)]))):v("",!0),(l(!0),n(T,null,N(_.value,e=>(l(),n("div",{key:e.id,class:"p-6 transition-colors duration-200 cursor-pointer trip-card hover:bg-gray-50",onClick:a=>ie(e.id)},[t("div",Se,[t("div",Ve,[t("div",De,[t("h4",Fe,r(e.origin)+" → "+r(e.destination),1),e.status==="pending"?(l(),n("span",He,"รอดำเนินการ")):e.status==="confirmed"?(l(),n("span",Ee,"ยืนยันแล้ว")):e.status==="rejected"?(l(),n("span",Oe,"ปฏิเสธ")):e.status==="cancelled"?(l(),n("span",ze,"ยกเลิก")):v("",!0)]),t("p",Ie,"จุดนัดพบ: "+r(e.pickupPoint),1),t("p",Ge,[P(" วันที่: "+r(e.date)+" ",1),s[3]||(s[3]=t("span",{class:"mx-2 text-gray-300"},"|",-1)),P(" เวลา: "+r(e.time)+" ",1),s[4]||(s[4]=t("span",{class:"mx-2 text-gray-300"},"|",-1)),P(" ระยะเวลา: "+r(e.durationText)+" ",1),s[5]||(s[5]=t("span",{class:"mx-2 text-gray-300"},"|",-1)),P(" ระยะทาง: "+r(e.distanceText),1)])])]),t("div",Ke,[t("img",{src:e.passenger.image,alt:e.passenger.name,class:"object-cover rounded-full w-15 h-15"},null,8,Re),t("div",qe,[t("div",Je,[t("h5",Ue,r(e.passenger.name),1),e.passenger.isVerified?(l(),n("div",We,s[6]||(s[6]=[t("svg",{class:"w-5 h-5 text-blue-600",viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.498 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.07-.01l3.5-4.875z","clip-rule":"evenodd"})],-1),t("span",{class:"absolute px-2 py-1 mb-2 text-xs text-white transition-opacity -translate-x-1/2 bg-gray-800 rounded-md opacity-0 pointer-events-none bottom-full left-1/2 w-max group-hover:opacity-100"}," ผู้โดยสารยืนยันตัวตนแล้ว ",-1)]))):v("",!0)]),t("div",Qe,[e.passenger.email?(l(),n("p",Xe,[s[7]||(s[7]=P(" อีเมล: ")),t("a",{href:`mailto:${e.passenger.email}`,class:"text-blue-600 hover:underline",onClick:s[0]||(s[0]=A(()=>{},["stop"]))},r(e.passenger.email),9,Ye)])):v("",!0),e.passenger.email?(l(),n("button",{key:1,class:"inline-flex items-center ml-1 text-gray-500 rounded hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",title:"คัดลอกอีเมล","aria-label":"คัดลอกอีเมล",onClick:A(a=>ce(e.passenger.email),["stop"])},s[8]||(s[8]=[t("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z"}),t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7V5a2 2 0 00-2-2H8a2 2 0 00-2 2v2"})],-1)]),8,Ze)):v("",!0)]),t("div",et,[t("div",tt,[t("span",null,r("★".repeat(Math.round(e.passenger.rating)))+r("☆".repeat(5-Math.round(e.passenger.rating))),1)]),t("span",st,r(e.passenger.rating)+" ("+r(e.passenger.reviews)+" รีวิว) ",1)])]),t("div",ot,[t("div",at,r(e.price)+" บาท",1),t("div",nt,"จำนวน "+r(e.seats)+" ที่นั่ง",1)])]),C.value===e.id?(l(),n("div",lt,[t("div",it,[t("div",null,[s[9]||(s[9]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดเส้นทาง",-1)),t("ul",rt,[e.originAddress?(l(),n("li",dt,"• จุดเริ่มต้น (ที่อยู่): "+r(e.originAddress),1)):v("",!0),e.destinationAddress?(l(),n("li",ct,"• จุดปลายทาง (ที่อยู่): "+r(e.destinationAddress),1)):v("",!0),(l(!0),n(T,null,N(e.stops,a=>(l(),n("li",{key:a},"• "+r(a),1))),128))])]),t("div",null,[s[10]||(s[10]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รายละเอียดรถ",-1)),t("ul",ut,[(l(!0),n(T,null,N(e.carDetails,a=>(l(),n("li",{key:a},"• "+r(a),1))),128))])])]),t("div",mt,[e.conditions?(l(),n("div",gt,[s[11]||(s[11]=t("h5",{class:"mb-2 font-medium text-gray-900"},"เงื่อนไขการเดินทาง",-1)),t("p",pt,r(e.conditions),1)])):v("",!0),e.photos&&e.photos.length>0?(l(),n("div",ft,[s[12]||(s[12]=t("h5",{class:"mb-2 font-medium text-gray-900"},"รูปภาพรถยนต์",-1)),t("div",vt,[(l(!0),n(T,null,N(e.photos.slice(0,3),(a,d)=>(l(),n("div",{key:d},[t("img",{src:a,alt:"Vehicle photo",class:"object-cover w-full transition-opacity rounded-lg shadow-sm cursor-pointer aspect-video hover:opacity-90"},null,8,yt)]))),128))])])):v("",!0)])])):v("",!0),t("div",{class:ae(["flex justify-end space-x-3",{"mt-4":C.value!==e.id}])},[e.status==="pending"?(l(),n(T,{key:0},[t("button",{onClick:A(a=>U(e,"confirm"),["stop"]),class:"px-4 py-2 text-sm text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700"}," ยืนยันคำขอ ",8,ht),t("button",{onClick:A(a=>U(e,"reject"),["stop"]),class:"px-4 py-2 text-sm text-red-600 transition duration-200 border border-red-300 rounded-md hover:bg-red-50"}," ปฏิเสธ ",8,xt)],64)):e.status==="confirmed"?(l(),n("button",bt," แชทกับผู้โดยสาร ")):["rejected","cancelled"].includes(e.status)?(l(),n("button",{key:2,onClick:A(a=>U(e,"delete"),["stop"]),class:"px-4 py-2 text-sm text-gray-600 transition duration-200 border border-gray-300 rounded-md hover:bg-gray-50"}," ลบรายการ ",8,_t)):v("",!0)],2)],8,Le))),128))]))])]),t("div",kt,[t("div",wt,[t("div",Ct,[s[14]||(s[14]=t("h3",{class:"text-lg font-semibold text-gray-900"},"แผนที่เส้นทาง",-1)),t("p",Mt,r(R.value?R.value.origin+" → "+R.value.destination:"คลิกที่รายการเพื่อดูเส้นทาง"),1)]),t("div",{ref_key:"mapContainer",ref:z,id:"map"},null,512)])])])]),ye(be,{show:J.value,title:k.value.title,message:k.value.message,confirmText:k.value.confirmText,variant:k.value.variant,onConfirm:de,onCancel:W},null,8,["show","title","message","confirmText","variant"])]))}},Vt=me(Tt,[["__scopeId","data-v-99d3cd5c"]]);export{Vt as default};
