import{_ as O,m as q,r as c,x as V,i as G,B as J,p as K,c as o,a as t,b as Q,F as g,q as p,g as u,t as n,o as r,n as A,f as E,s as R}from"./DPSIKoxe.js";import{d as b}from"./B5yDJBm8.js";import{b as U}from"./C5FTVxxA.js";import{C as W}from"./CL2Ezi0q.js";import{u as X}from"./BaxiziUg.js";import{s as Y}from"./x_rD_Ya3.js";import"./Cpj98o6Y.js";const Z={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},ee={class:"bg-white border border-gray-300 rounded-lg shadow-md p-6 mb-8"},te={class:"flex flex-wrap gap-2"},se=["onClick"],ae={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},oe={class:"lg:col-span-2"},re={class:"bg-white border border-gray-300 rounded-lg shadow-md"},le={key:0,class:"p-12 text-center text-gray-500"},ne={key:1,class:"divide-y divide-gray-200"},ie={key:0,class:"p-12 text-center text-gray-500"},de=["onClick"],ce={class:"flex items-start justify-between mb-4"},ue={class:"flex-1"},me={class:"flex items-center justify-between"},ve={class:"font-semibold text-gray-900 text-lg"},he={key:0,class:"status-badge status-pending"},fe={key:1,class:"status-badge status-confirmed"},ge={key:2,class:"status-badge status-rejected"},pe={key:3,class:"status-badge status-cancelled"},_e={class:"text-sm text-gray-600 mt-1"},xe={class:"text-sm text-gray-600"},ye={class:"flex items-center space-x-4 mb-4"},be=["src","alt"],we={class:"flex-1"},Te={class:"font-medium text-gray-900"},Ce={class:"flex items-center"},Le={class:"flex text-yellow-400 text-sm"},ke={class:"ml-2 text-sm text-gray-600"},Me={class:"text-right"},$e={class:"text-lg font-bold text-blue-600"},je={class:"text-sm text-gray-600"},Be={key:0,class:"mt-4 mb-5 pt-4 border-t border-gray-300 animate-in slide-in-from-top duration-300"},De={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ne={class:"text-sm text-gray-600 space-y-1"},Pe={class:"text-sm text-gray-600 space-y-1"},Fe={class:"mt-4 space-y-4"},Ve={key:0},Ae={class:"text-sm text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-300"},Ee={key:1},Se={class:"grid grid-cols-3 gap-2 mt-2"},He=["src"],Ie=["onClick"],ze={key:1,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 text-sm"},Oe=["onClick"],qe={class:"lg:col-span-1"},Ge={class:"bg-white border border-gray-300 rounded-lg shadow-md overflow-hidden sticky top-8"},Je={class:"p-3 border-gray-300"},Ke={class:"text-sm text-gray-600 mt-1"},Qe={__name:"index_v1",setup(Re){b.locale("th"),b.extend(U);const{$api:j}=q(),{toast:B}=R(),f=c("pending"),m=c(null),w=c(!1),T=c(null);let i=null,_=null,C=[];const d=c([]),S=[{status:"pending",label:"รอดำเนินการ"},{status:"confirmed",label:"ยืนยันแล้ว"},{status:"rejected",label:"ปฏิเสธ"},{status:"cancelled",label:"ยกเลิก"},{status:"all",label:"ทั้งหมด"}],x=V(()=>f.value==="all"?d.value:d.value.filter(a=>a.status===f.value)),k=V(()=>d.value.find(a=>a.id===m.value)||null);async function D(){w.value=!0;try{const s=(await j("/bookings/me")).map(e=>{var F;const l={name:`${e.route.driver.firstName} ${e.route.driver.lastName}`,image:e.route.driver.profilePicture||`https://ui-avatars.com/api/?name=${e.route.driver.firstName}&background=random&size=64`,rating:4.5,reviews:Math.floor(Math.random()*50)+5},h=[];return e.route.vehicle?(h.push(`${e.route.vehicle.vehicleModel} (${e.route.vehicle.vehicleType})`),e.route.vehicle.amenities&&e.route.vehicle.amenities.length>0&&h.push(...e.route.vehicle.amenities)):h.push("ไม่มีข้อมูลรถ"),{id:e.id,status:e.status.toLowerCase(),origin:`จาก Lat: ${e.route.startLocation.lat.toFixed(2)}`,destination:`ถึง Lat: ${e.route.endLocation.lat.toFixed(2)}`,pickupPoint:e.pickupLocation.name,date:b(e.route.departureTime).format("D MMMM BBBB"),time:b(e.route.departureTime).format("HH:mm น."),price:e.route.pricePerSeat*e.numberOfSeats,seats:e.numberOfSeats,driver:l,coords:[[e.route.startLocation.lat,e.route.startLocation.lng],[e.route.endLocation.lat,e.route.endLocation.lng]],stops:["ไม่มีข้อมูลจุดแวะพัก"],carDetails:h,conditions:e.route.conditions,photos:(F=e.route.vehicle)==null?void 0:F.photos}});d.value=s}catch(a){console.error("Failed to fetch my trips:",a),d.value=[]}finally{w.value=!1}}const H=a=>a==="all"?d.value.length:d.value.filter(s=>s.status===a).length,I=a=>{const s=d.value.find(e=>e.id===a);s&&N(s),m.value===a?m.value=null:m.value=a},N=a=>{if(!i||!a)return;_&&i.removeLayer(_),C.forEach(l=>i.removeLayer(l)),C=[],_=L.polyline(a.coords,{color:"#3b82f6",weight:4}).addTo(i);const s=L.marker(a.coords[0]).bindPopup("จุดเริ่มต้น").addTo(i),e=L.marker(a.coords[a.coords.length-1]).bindPopup("จุดปลายทาง").addTo(i);C.push(s,e),i.fitBounds(_.getBounds(),{padding:[40,40]})},M=c(!1),y=c(null),v=c({title:"",message:"",confirmText:"",action:null,variant:"danger"}),P=(a,s)=>{y.value=a,s==="cancel"?v.value={title:"ยืนยันการยกเลิกการจอง",message:`คุณต้องการยกเลิกการเดินทางไปที่ "${a.destination}" ใช่หรือไม่?`,confirmText:"ใช่, ยกเลิกการจอง",action:"cancel",variant:"danger"}:s==="delete"&&(v.value={title:"ยืนยันการลบรายการ",message:`คุณต้องการลบรายการเดินทางไปที่ "${a.destination}" ออกจากประวัติใช่หรือไม่?`,confirmText:"ใช่, ลบรายการ",action:"delete",variant:"danger"}),M.value=!0},$=()=>{M.value=!1,y.value=null},z=async()=>{var e;if(!y.value)return;const a=v.value.action,s=y.value.id;try{a==="cancel"?(await j(`/bookings/${s}/cancel`,{method:"PATCH",body:{status:"CANCELLED"}}),B.success("ยกเลิกการจองสำเร็จ","การจองของคุณถูกยกเลิกแล้ว")):a==="delete"&&console.log(`Deleting booking ID: ${s}`),$(),await D()}catch(l){console.error(`Failed to ${a} booking:`,l),B.error("เกิดข้อผิดพลาด",((e=l.data)==null?void 0:e.message)||"ไม่สามารถดำเนินการได้"),$()}};return X({}),G(()=>{D();const a=Y(()=>{typeof L<"u"&&(clearInterval(a),J(()=>{T.value&&!i&&(i=L.map(T.value).setView([13.7563,100.5018],6),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(i))}))},100)}),K(f,()=>{m.value=null,x.value.length>0&&N(x.value[0])}),(a,s)=>(r(),o("div",null,[t("div",Z,[s[8]||(s[8]=t("div",{class:"mb-8"},[t("h2",{class:"text-2xl font-bold text-gray-900"},"การเดินทางของฉัน"),t("p",{class:"mt-2 text-gray-600"},"จัดการและติดตามการเดินทางทั้งหมดของคุณ")],-1)),t("div",ee,[t("div",te,[(r(),o(g,null,p(S,e=>t("button",{key:e.status,onClick:l=>f.value=e.status,class:A(["tab-button px-4 py-2 rounded-md font-medium",{active:f.value===e.status}])},n(e.label)+" ("+n(H(e.status))+") ",11,se)),64))])]),t("div",ae,[t("div",oe,[t("div",re,[s[6]||(s[6]=t("div",{class:"p-6 border-b border-gray-300"},[t("h3",{class:"text-lg font-semibold text-gray-900"},"รายการการเดินทาง")],-1)),w.value?(r(),o("div",le,s[0]||(s[0]=[t("p",null,"กำลังโหลดข้อมูลการเดินทาง...",-1)]))):(r(),o("div",ne,[x.value.length===0?(r(),o("div",ie,s[1]||(s[1]=[t("p",null,"ไม่พบรายการเดินทางในหมวดหมู่นี้",-1)]))):u("",!0),(r(!0),o(g,null,p(x.value,e=>(r(),o("div",{key:e.id,class:"trip-card p-6 cursor-pointer transition-colors duration-200 hover:bg-gray-50",onClick:l=>I(e.id)},[t("div",ce,[t("div",ue,[t("div",me,[t("h4",ve,n(e.origin)+" → "+n(e.destination),1),e.status==="pending"?(r(),o("span",he,"รอดำเนินการ")):e.status==="confirmed"?(r(),o("span",fe,"ยืนยันแล้ว")):e.status==="rejected"?(r(),o("span",ge,"ปฏิเสธ")):e.status==="cancelled"?(r(),o("span",pe,"ยกเลิก")):u("",!0)]),t("p",_e,"จุดนัดพบ: "+n(e.pickupPoint),1),t("p",xe,"วันที่: "+n(e.date)+" เวลา: "+n(e.time),1)])]),t("div",ye,[t("img",{src:e.driver.image,alt:e.driver.name,class:"w-12 h-12 rounded-full object-cover"},null,8,be),t("div",we,[t("h5",Te,n(e.driver.name),1),t("div",Ce,[t("div",Le,[t("span",null,n("★".repeat(Math.round(e.driver.rating)))+n("☆".repeat(5-Math.round(e.driver.rating))),1)]),t("span",ke,n(e.driver.rating)+" ("+n(e.driver.reviews)+" รีวิว)",1)])]),t("div",Me,[t("div",$e,n(e.price)+" บาท",1),t("div",je,"จำนวน "+n(e.seats)+" ที่นั่ง",1)])]),m.value===e.id?(r(),o("div",Be,[t("div",De,[t("div",null,[s[2]||(s[2]=t("h5",{class:"font-medium text-gray-900 mb-2"},"รายละเอียดเส้นทาง",-1)),t("ul",Ne,[(r(!0),o(g,null,p(e.stops,l=>(r(),o("li",{key:l},"• "+n(l),1))),128))])]),t("div",null,[s[3]||(s[3]=t("h5",{class:"font-medium text-gray-900 mb-2"},"รายละเอียดรถ",-1)),t("ul",Pe,[(r(!0),o(g,null,p(e.carDetails,l=>(r(),o("li",{key:l},"• "+n(l),1))),128))])])]),t("div",Fe,[e.conditions?(r(),o("div",Ve,[s[4]||(s[4]=t("h5",{class:"font-medium text-gray-900 mb-2"},"เงื่อนไขการเดินทาง",-1)),t("p",Ae,n(e.conditions),1)])):u("",!0),e.photos&&e.photos.length>0?(r(),o("div",Ee,[s[5]||(s[5]=t("h5",{class:"font-medium text-gray-900 mb-2"},"รูปภาพรถยนต์",-1)),t("div",Se,[(r(!0),o(g,null,p(e.photos.slice(0,3),(l,h)=>(r(),o("div",{key:h},[t("img",{src:l,alt:"Vehicle photo",class:"w-full aspect-video object-cover rounded-lg shadow-sm cursor-pointer hover:opacity-90 transition-opacity"},null,8,He)]))),128))])])):u("",!0)])])):u("",!0),t("div",{class:A(["flex justify-end space-x-3",{"mt-4":m.value!==e.id}])},[e.status==="pending"?(r(),o("button",{key:0,onClick:E(l=>P(e,"cancel"),["stop"]),class:"px-4 py-2 border border-red-300 text-red-600 rounded-md hover:bg-red-50 transition duration-200 text-sm"}," ยกเลิกการจอง ",8,Ie)):u("",!0),e.status==="confirmed"?(r(),o("button",ze," แชทกับผู้ขับ ")):u("",!0),["rejected","cancelled"].includes(e.status)?(r(),o("button",{key:2,onClick:E(l=>P(e,"delete"),["stop"]),class:"px-4 py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 transition duration-200 text-sm"}," ลบรายการ ",8,Oe)):u("",!0)],2)],8,de))),128))]))])]),t("div",qe,[t("div",Ge,[t("div",Je,[s[7]||(s[7]=t("h3",{class:"text-lg font-semibold text-gray-900"},"แผนที่เส้นทาง",-1)),t("p",Ke,n(k.value?k.value.origin+" → "+k.value.destination:"คลิกที่รายการเพื่อดูเส้นทาง"),1)]),t("div",{ref_key:"mapContainer",ref:T,id:"map"},null,512)])])])]),Q(W,{show:M.value,title:v.value.title,message:v.value.message,confirmText:v.value.confirmText,variant:v.value.variant,onConfirm:z,onCancel:$},null,8,["show","title","message","confirmText","variant"])]))}},st=O(Qe,[["__scopeId","data-v-01526f95"]]);export{st as default};
